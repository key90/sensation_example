<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢–≤–æ—ë –ø–æ—Å–ª–∞–Ω–∏–µ ‚Äî TBM</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="card-page">
  <div class="card-scene">
    <article id="card" class="card" role="document" aria-live="polite">
      <div class="card-inner">
        <div class="frame">
          <div id="petalLayer" class="petal-layer" aria-hidden="true"></div>

          <header class="card-header">
            <h1 id="recipientName" class="recipient"></h1>
            <p id="flowersLine" class="flowers-line"></p>
          </header>

          <section id="messageText" class="message"></section>

          <footer class="card-footer">
            <div id="senderLine" class="sender"></div>
            <div id="dateLine" class="date muted"></div>
          </footer>
        </div>
      </div>
    </article>

    <div id="errorBox" class="error hidden">–û—Ç–∫—Ä—ã—Ç–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</div>
  </div>

  <!-- –õ—ë–≥–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫ (–ø–∏–∞–Ω–∏–Ω–æ + —Å—Ç—Ä—É–Ω–Ω—ã–µ) ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ -->
  <audio id="bgAudio" loop preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_6b3f5ea2b1.mp3?filename=soft-piano-violin-10807.mp3" type="audio/mpeg">
    <!-- –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å ‚Äî –ø–æ–ª–æ–∂–∏ melody.mp3 —Ä—è–¥–æ–º –∏ –≤—Å—Ç–∞–≤—å "melody.mp3" -->
  </audio>

<script>
/* card.html logic:
 - —á–∏—Ç–∞–µ—Ç p (—Ñ–æ—Ä–º–∞—Ç: base64url(json)).checksum
 - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç checksum (SHA-256 ‚Üí –ø–µ—Ä–≤—ã–µ 12 hex)
 - –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É
 - –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É —Å fade-in 3s; –µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚Äî –ø—Ä–æ—Å–∏—Ç –∫–ª–∏–∫ (iOS)
 - —Å–æ–∑–¥–∞–µ—Ç –ø–∞–¥–∞—é—â–∏–µ –ª–µ–ø–µ—Å—Ç–∫–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ
*/

function b64DecodeUnicode(str){
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length % 4) str += '=';
  return decodeURIComponent(escape(atob(str)));
}
async function sha256hex(msg){
  const enc = new TextEncoder();
  const data = enc.encode(msg);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function showError(){
  document.getElementById('errorBox').classList.remove('hidden');
  document.getElementById('card').classList.remove('visible');
}

(async function(){
  const params = new URLSearchParams(location.search);
  const p = params.get('p');
  if(!p) return showError();

  const parts = p.split('.');
  if(parts.length !== 2) return showError();
  const [b64, checksum] = parts;

  let json;
  try { json = b64DecodeUnicode(b64); } catch(e){ return showError(); }

  const computed = await sha256hex(json);
  if(computed.slice(0,12) !== checksum) return showError();

  let data;
  try { data = JSON.parse(json); } catch(e){ return showError(); }

  // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É (–∏–º—è –±–µ–∑ "–î–ª—è")
  document.getElementById('recipientName').textContent = data.recipient || '';
  document.getElementById('messageText').textContent = data.message || '';
  document.getElementById('flowersLine').textContent = data.flowers ? 'üå∑ ' + data.flowers : '';
  document.getElementById('senderLine').textContent = data.sender ? '–û—Ç: ' + data.sender : '';
  document.getElementById('dateLine').textContent = new Date(data.date || Date.now()).toLocaleDateString('ru-RU');

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
  document.getElementById('card').classList.add('visible');

  // –ø–∞–¥–∞—é—â–∏–µ –ª–µ–ø–µ—Å—Ç–∫–∏ (emoji) ‚Äî —Ä–∞–∑–Ω—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∑–∞–¥–µ—Ä–∂–∫–∏
  const petalLayer = document.getElementById('petalLayer');
  for(let i=0;i<28;i++){
    const el = document.createElement('span');
    el.className = 'petal';
    el.textContent = ['üå∏','üåº','üå∑','üå∫'][Math.floor(Math.random()*4)];
    el.style.left = (Math.random()*100) + '%';
    const s = 8 + Math.random()*10;
    el.style.animationDuration = s + 's';
    el.style.animationDelay = (Math.random()*4) + 's';
    el.style.opacity = 0.6 + Math.random()*0.4;
    el.style.transform = `scale(${0.7 + Math.random()*0.9})`;
    petalLayer.appendChild(el);
  }

  // –ú—É–∑—ã–∫–∞ —Å fade-in 3s
  const audio = document.getElementById('bgAudio');
  let playing = false;
  async function fadeInAudio(duration = 3){
    try {
      audio.volume = 0;
      await audio.play();
      playing = true;
      const steps = 30;
      let i = 0;
      const interval = duration*1000/steps;
      const timer = setInterval(()=> {
        i++;
        audio.volume = Math.min(1, i/steps);
        if(i>=steps) clearInterval(timer);
      }, interval);
    } catch(err){
      // –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∞–≤—Ç–æ–ø–ª–µ–π ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –∫–ª–∏–∫ –ø–æ –æ—Ç–∫—Ä—ã—Ç–∫–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
      const hint = document.createElement('div');
      hint.className = 'tap-hint';
      hint.textContent = '–ù–∞–∂–º–∏—Ç–µ –ø–æ –æ—Ç–∫—Ä—ã—Ç–∫–µ, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
      document.body.appendChild(hint);
      function oncePlay(){
        audio.play().then(()=> {
          playing = true;
          // –ø–ª–∞–≤–Ω—ã–π fadeIn –≤—Ä—É—á–Ω—É—é
          let i=0; const steps=30; const interval=3000/steps;
          audio.volume = 0;
          const timer = setInterval(()=>{ i++; audio.volume = Math.min(1, i/steps); if(i>=steps) clearInterval(timer); }, interval);
        }).catch(()=>{});
        hint.remove();
        document.getElementById('card').removeEventListener('click', oncePlay);
      }
      document.getElementById('card').addEventListener('click', oncePlay, { once:true });
    }
  }

  // –ø–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
  fadeInAudio(3);

})();
</script>
</body>
</html>
